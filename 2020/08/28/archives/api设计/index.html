

<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>api设计 - 李博文的个人博客</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="google" content="notranslate" />

  
  <meta name="keywords" content="李博文"> 
  
  <meta name="description" content="一、token 简介Token：访问令牌access ..."> 
  
  <meta name="author" content="Libowen"> 

  
    <link rel="icon" href="/images/icons/favicon-16x16.png" type="image/png" sizes="16x16">
  
  
    <link rel="icon" href="/images/icons/favicon-32x32.png" type="image/png" sizes="32x32">
  
  
    <link rel="apple-touch-icon" href="/images/icons/apple-touch-icon.png" sizes="180x180">
  
  
    <meta rel="mask-icon" href="/images/icons/zhaoo-logo.png" color="#333333">
  
  
    <meta rel="msapplication-TileImage" content="/images/icons/favicon-144x144.png">
    <meta rel="msapplication-TileColor" content="#000000">
  

  
<link rel="stylesheet" href="/css/style.css">


  
  
<link rel="stylesheet" href="//at.alicdn.com/t/font_1445822_0sri83bhiv7.css">

  

  
  
  
<link rel="stylesheet" href="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css">

  

  
  
  
<link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.18.1/styles/xcode.min.css">

  

  
  
  
<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css">

  

  <script>
    var CONFIG = window.CONFIG || {};
    var ZHAOO = window.ZHAOO || {};
    CONFIG = {
      fancybox: true,
      pjax: false,
      lazyload: {
        enable: true,
        loadingImage: '/images/theme/loading.gif',
      },
      donate: {
        enable: true,
        alipay: 'https://cdn.jsdelivr.net/gh/leebw529/pic/img/Yssy17eo0u.png',
        wechat: 'https://cdn.jsdelivr.net/gh/leebw529/pic/img/e8afdq6V0l.png'
      },
      motto: {
        api: '',
        default: '还好 还好 还好我们遇见过 。'
      },
      galleries: {
        enable: true
      },
      fab: {
        enable: true,
        alwaysShow: false
      },
      carrier: {
        enable: true
      },
      daovoice: {
        enable: true
      }
    }
  </script>

  

  
<meta name="generator" content="Hexo 5.0.0"></head>
<body class="lock-screen">
  <div class="loading"></div>
  <nav class="menu">
  <div class="menu-close">
    <i class="iconfont iconplus"></i>
  </div>
  <ul class="menu-content">
    
    
    
    
    <li class="menu-item"><a href="/ " class="underline"> 首页</a></li>
    
    
    
    
    <li class="menu-item"><a href="/galleries " class="underline"> 摄影</a></li>
    
    
    
    
    <li class="menu-item"><a href="/archives " class="underline"> 归档</a></li>
    
    
    
    
    <li class="menu-item"><a href="/tags " class="underline"> 标签</a></li>
    
    
    
    
    <li class="menu-item"><a href="/categories " class="underline"> 分类</a></li>
    
    
    
    
    <li class="menu-item"><a href="/about " class="underline"> 关于</a></li>
    
  </ul>
  <div class="menu-copyright"><p>还好 还好 还好遇见过你</p></div>
</nav>
  <main id="main">
  <div class="container" id="container">
    <article class="article">
  <section class="head">
  <img   class="lazyload" data-original="/images/theme/post-image.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  draggable="false">
  <div class="head-mask">
    <h1 class="head-title">api设计</h1>
    <div class="head-info">
      <span class="post-info-item"><i class="iconfont iconcalendar"></i>8月 28, 2020</span
        class="post-info-item">
      
      <span class="post-info-item"><i class="iconfont iconfont-size"></i>23877</span>
    </div>
  </div>
</section>
  <section class="main">
    <section class="content">
      <h2 id="一、token-简介"><a href="#一、token-简介" class="headerlink" title="一、token 简介"></a><strong>一、token 简介</strong></h2><p><code>Token</code>：访问令牌<code>access token</code>, 用于接口中,  用于标识接口调用者的身份、凭证，减少用户名和密码的传输次数。一般情况下客户端(接口调用方)需要先向服务器端申请一个接口调用的账号，服务器会给出一个<code>appId</code>和一个<code>key</code>, <code>key</code>用于参数签名使用，注意<code>key</code>保存到客户端，需要做一些安全处理，防止泄露。</p>
<p><code>Token</code>的值一般是<code>UUID</code>，服务端生成<code>Token</code>后需要将<code>token</code>做为<code>key</code>，将一些和<code>token</code>关联的信息作为<code>value</code>保存到缓存服务器中(<code>redis</code>)，当一个请求过来后，服务器就去缓存服务器中查询这个<code>Token</code>是否存在，存在则调用接口，不存在返回接口错误，一般通过拦截器或者过滤器来实现，<code>Token</code>分为两种：</p>
<ul>
<li><code>API Token</code>(接口令牌): 用于访问不需要用户登录的接口，如登录、注册、一些基本数据的获取等。获取接口令牌需要拿<code>appId、timestamp和sign</code>来换，<code>sign=加密(timestamp+key)</code></li>
<li><code>USER Token(用户令牌</code>): 用于访问需要用户登录之后的接口，如：获取我的基本信息、保存、修改、删除等操作。获取用户令牌需要拿用户名和密码来换</li>
</ul>
<p>关于<code>Token</code>的时效性：<code>token</code>可以是一次性的、也可以在一段时间范围内是有效的，具体使用哪种看业务需要。</p>
<p>一般情况下接口最好使用<code>https</code>协议，如果使用<code>http</code>协议，<code>Token</code>机制只是一种减少被黑的可能性，其实只能防君子不能防小人。</p>
<p>一般<code>token</code>、<code>timestamp</code>和sign 三个参数会在接口中会同时作为参数传递，每个参数都有各自的用途。</p>
<h2 id="二、timestamp-简介"><a href="#二、timestamp-简介" class="headerlink" title="二、timestamp 简介"></a><strong>二、timestamp 简介</strong></h2><p><code>timestamp</code>: 时间戳，是客户端调用接口时对应的当前时间戳，时间戳用于防止DoS攻击。</p>
<p>当黑客劫持了请求的<code>url</code>去<code>DoS</code>攻击，每次调用接口时接口都会判断服务器当前系统时间和接口中传的的<code>timestamp</code>的差值，如果这个差值超过某个设置的时间(假如5分钟)，那么这个请求将被拦截掉，如果在设置的超时时间范围内，是不能阻止<code>DoS</code>攻击的。<code>timestamp</code>机制只能减轻<code>DoS</code>攻击的时间，缩短攻击时间。如果黑客修改了时间戳的值可通过sign签名机制来处理。</p>
<p><strong>DoS</strong></p>
<p><code>DoS</code>是<code>Denial of Service</code>的简称，即拒绝服务，造成<code>DoS</code>的攻击行为被称为<code>DoS</code>攻击，其目的是使计算机或网络无法提供正常的服务。最常见的<code>DoS</code>攻击有计算机网络带宽攻击和连通性攻击。</p>
<p><code>DoS</code>攻击是指故意的攻击网络协议实现的缺陷或直接通过野蛮手段残忍地耗尽被攻击对象的资源，目的是让目标计算机或网络无法提供正常的服务或资源访问，使目标系统服务系统停止响应甚至崩溃，而在此攻击中并不包括侵入目标服务器或目标网络设备。这些服务资源包括网络带宽，文件系统空间容量，开放的进程或者允许的连接。这种攻击会导致资源的匮乏，无论计算机的处理速度多快、内存容量多大、网络带宽的速度多快都无法避免这种攻击带来的后果。</p>
<ul>
<li><code>Pingflood</code>: 该攻击在短时间内向目的主机发送大量<code>ping</code>包，造成网络堵塞或主机资源耗尽。</li>
<li><code>Synflood</code>: 该攻击以多个随机的源主机地址向目的主机发送<code>SYN</code>包，而在收到目的主机的``SYN ACK<code>后并不回应，这样，目的主机就为这些源主机建立了大量的连接队列，而且由于没有收到</code>ACK`一直维护着这些队列，造成了资源的大量消耗而不能向正常请求提供服务。</li>
<li><code>Smurf</code>：该攻击向一个子网的广播地址发一个带有特定请求（如<code>ICMP</code>回应请求）的包，并且将源地址伪装成想要攻击的主机地址。子网上所有主机都回应广播包请求而向被攻击主机发包，使该主机受到攻击。</li>
<li><code>Land-based</code>：攻击者将一个包的源地址和目的地址都设置为目标主机的地址，然后将该包通过<code>IP</code>欺骗的方式发送给被攻击主机，这种包可以造成被攻击主机因试图与自己建立连接而陷入死循环，从而很大程度地降低了系统性能。</li>
<li><code>Ping of  Death</code>：根据<code>TCP/IP</code>的规范，一个包的长度最大为65536字节。尽管一个包的长度不能超过65536字节，但是一个包分成的多个片段的叠加却能做到。当一个主机收到了长度大于65536字节的包时，就是受到了<code>Ping of Death</code>攻击，该攻击会造成主机的宕机。</li>
<li><code>Teardrop：IP</code>数据包在网络传递时，数据包可以分成更小的片段。攻击者可以通过发送两段（或者更多）数据包来实现<code>TearDrop</code>攻击。第一个包的偏移量为0，长度为N，第二个包的偏移量小于N。为了合并这些数据段，<code>TCP/IP</code>堆栈会分配超乎寻常的巨大资源，从而造成系统资源的缺乏甚至机器的重新启动。</li>
<li><code>PingSweep</code>：使用I<code>CMP Echo</code>轮询多个主机。</li>
</ul>
<h2 id="三、sign-简介"><a href="#三、sign-简介" class="headerlink" title="三、sign 简介"></a><strong>三、sign 简介</strong></h2><p><code>nonce</code>：随机值，是客户端随机生成的值，作为参数传递过来，随机值的目的是增加<code>sign</code>签名的多变性。随机值一般是数字和字母的组合，6位长度，随机值的组成和长度没有固定规则。</p>
<p><code>sign</code>: 一般用于参数签名，防止参数被非法篡改，最常见的是修改金额等重要敏感参数，  <code>sign</code>的值一般是将所有非空参数按照升续排序然后<code>+token+key+timestamp+nonce</code>(随机数)拼接在一起，然后使用某种加密算法进行加密，作为接口中的一个参数<code>sign</code>来传递，也可以将<code>sign</code>放到请求头中。</p>
<p>接口在网络传输过程中如果被黑客挟持，并修改其中的参数值，然后再继续调用接口，虽然参数的值被修改了，但是因为黑客不知道<code>sign</code>是如何计算出来的，不知道<code>sign</code>都有哪些值构成，不知道以怎样的顺序拼接在一起的，最重要的是不知道签名字符串中的<code>key</code>是什么，所以黑客可以篡改参数的值，但没法修改<code>sign</code>的值，当服务器调用接口前会按照<code>sign</code>的规则重新计算出<code>sign</code>的值然后和接口传递的<code>sign</code>参数的值做比较，如果相等表示参数值没有被篡改，如果不等，表示参数被非法篡改了，就不执行接口了。</p>
<h2 id="四、防止重复提交"><a href="#四、防止重复提交" class="headerlink" title="四、防止重复提交"></a><strong>四、防止重复提交</strong></h2><p>对于一些重要的操作需要防止客户端重复提交的(如非幂等性重要操作)，具体办法是当请求第一次提交时将<code>sign</code>作为<code>key</code>保存到<code>redis</code>，并设置超时时间，超时时间和<code>Timestamp</code>中设置的差值相同。</p>
<p>当同一个请求第二次访问时会先检测<code>redis</code>是否存在该<code>sign</code>，如果存在则证明重复提交了，接口就不再继续调用了。如果<code>sign</code>在缓存服务器中因过期时间到了，而被删除了，此时当这个<code>url</code>再次请求服务器时，因<code>token</code>的过期时间和<code>sign</code>的过期时间一直，<code>sign</code>过期也意味着<code>token</code>过期，那样同样的<code>url</code>再访问服务器会因<code>token</code>错误会被拦截掉，这就是为什么<code>sign</code>和<code>token</code>的过期时间要保持一致的原因。拒绝重复调用机制确保<code>URL</code>被别人截获了也无法使用（如抓取数据）。</p>
<p>对于哪些接口需要防止重复提交可以自定义个注解来标记。</p>
<p>注意：所有的安全措施都用上的话有时候难免太过复杂，在实际项目中需要根据自身情况作出裁剪，比如可以只使用签名机制就可以保证信息不会被篡改，或者定向提供服务的时候只用<code>Token</code>机制就可以了。如何裁剪，全看项目实际情况和对接口安全性的要求。</p>
<h2 id="五、使用流程"><a href="#五、使用流程" class="headerlink" title="五、使用流程"></a><strong>五、使用流程</strong></h2><p>1.接口调用方(客户端)向接口提供方(服务器)申请接口调用账号，申请成功后，接口提供方会给接口调用方一个<code>appId</code>和一个<code>key</code>参数</p>
<p>2.客户端携带参数<code>appId</code>、<code>timestamp</code>、<code>sign</code>去调用服务器端的<code>API token</code>，其中<code>sign=加密(appId + timestamp + key)</code></p>
<p>3.客户端拿着<code>api_token</code> 去访问不需要登录就能访问的接口</p>
<p>4.当访问用户需要登录的接口时，客户端跳转到登录页面，通过用户名和密码调用登录接口，登录接口会返回一个<code>usertoken</code>, 客户端拿着<code>usertoken</code> 去访问需要登录才能访问的接口</p>
<p><code>sign</code>的作用是防止参数被篡改，客户端调用服务端时需要传递sign参数，服务器响应客户端时也可以返回一个<code>sign</code>用于客户度校验返回的值是否被非法篡改了。客户端传的sign和服务器端响应的sign算法可能会不同。</p>
<h2 id="六、示例代码"><a href="#六、示例代码" class="headerlink" title="六、示例代码"></a><strong>六、示例代码</strong></h2><p><strong>1. dependency</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;<br>    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;<br>&lt;/dependency&gt;<br>&lt;dependency&gt;<br>    &lt;groupId&gt;redis.clients&lt;/groupId&gt;<br>    &lt;artifactId&gt;jedis&lt;/artifactId&gt;<br>    &lt;version&gt;2.9.0&lt;/version&gt;<br>&lt;/dependency&gt;<br><br><br>&lt;dependency&gt;<br>    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure>

<p><strong>2. RedisConfiguration</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisConfiguration</span> </span>&#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> JedisConnectionFactory <span class="hljs-title">jedisConnectionFactory</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JedisConnectionFactory();<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 支持存储对象</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> RedisTemplate&lt;String, String&gt; <span class="hljs-title">redisTemplate</span><span class="hljs-params">()</span></span>&#123;<br>        RedisTemplate&lt;String, String&gt; redisTemplate = <span class="hljs-keyword">new</span> StringRedisTemplate();<br>        redisTemplate.setConnectionFactory(jedisConnectionFactory());<br>        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = <span class="hljs-keyword">new</span> Jackson2JsonRedisSerializer(Object.class);<br>        ObjectMapper objectMapper = <span class="hljs-keyword">new</span> ObjectMapper();<br>        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);<br>        objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);<br><br><br>        jackson2JsonRedisSerializer.setObjectMapper(objectMapper);<br>        redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);<br>        redisTemplate.afterPropertiesSet();<br><br><br>        <span class="hljs-keyword">return</span> redisTemplate;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>3. TokenController</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/token&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TokenController</span> </span>&#123;<br><br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * API Token</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> sign</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping(&quot;/api_token&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ApiResponse&lt;AccessToken&gt; <span class="hljs-title">apiToken</span><span class="hljs-params">(String appId, <span class="hljs-meta">@RequestHeader(&quot;timestamp&quot;)</span> String timestamp, <span class="hljs-meta">@RequestHeader(&quot;sign&quot;)</span> String sign)</span> </span>&#123;<br>        Assert.isTrue(!StringUtils.isEmpty(appId) &amp;&amp; !StringUtils.isEmpty(timestamp) &amp;&amp; !StringUtils.isEmpty(sign), <span class="hljs-string">&quot;参数错误&quot;</span>);<br><br><br>        <span class="hljs-keyword">long</span> reqeustInterval = System.currentTimeMillis() - Long.valueOf(timestamp);<br>        Assert.isTrue(reqeustInterval &lt; <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-string">&quot;请求过期，请重新请求&quot;</span>);<br><br><br>        <span class="hljs-comment">// 1. 根据appId查询数据库获取appSecret</span><br>        AppInfo appInfo = <span class="hljs-keyword">new</span> AppInfo(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;12345678954556&quot;</span>);<br><br><br>        <span class="hljs-comment">// 2. 校验签名</span><br>        String signString = timestamp + appId + appInfo.getKey();<br>        String signature = MD5Util.encode(signString);<br>        log.info(signature);<br>        Assert.isTrue(signature.equals(sign), <span class="hljs-string">&quot;签名错误&quot;</span>);<br><br><br>        <span class="hljs-comment">// 3. 如果正确生成一个token保存到redis中，如果错误返回错误信息</span><br>        AccessToken accessToken = <span class="hljs-keyword">this</span>.saveToken(<span class="hljs-number">0</span>, appInfo, <span class="hljs-keyword">null</span>);<br><br><br>        <span class="hljs-keyword">return</span> ApiResponse.success(accessToken);<br>    &#125;<br><br><br><br><br>    <span class="hljs-meta">@NotRepeatSubmit(5000)</span><br>    <span class="hljs-meta">@PostMapping(&quot;user_token&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ApiResponse&lt;UserInfo&gt; <span class="hljs-title">userToken</span><span class="hljs-params">(String username, String password)</span> </span>&#123;<br>        <span class="hljs-comment">// 根据用户名查询密码, 并比较密码(密码可以RSA加密一下)</span><br>        UserInfo userInfo = <span class="hljs-keyword">new</span> UserInfo(username, <span class="hljs-string">&quot;81255cb0dca1a5f304328a70ac85dcbd&quot;</span>, <span class="hljs-string">&quot;111111&quot;</span>);<br>        String pwd = password + userInfo.getSalt();<br>        String passwordMD5 = MD5Util.encode(pwd);<br>        Assert.isTrue(passwordMD5.equals(userInfo.getPassword()), <span class="hljs-string">&quot;密码错误&quot;</span>);<br><br><br>        <span class="hljs-comment">// 2. 保存Token</span><br>        AppInfo appInfo = <span class="hljs-keyword">new</span> AppInfo(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;12345678954556&quot;</span>);<br>        AccessToken accessToken = <span class="hljs-keyword">this</span>.saveToken(<span class="hljs-number">1</span>, appInfo, userInfo);<br>        userInfo.setAccessToken(accessToken);<br>        <span class="hljs-keyword">return</span> ApiResponse.success(userInfo);<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> AccessToken <span class="hljs-title">saveToken</span><span class="hljs-params">(<span class="hljs-keyword">int</span> tokenType, AppInfo appInfo,  UserInfo userInfo)</span> </span>&#123;<br>        String token = UUID.randomUUID().toString();<br><br><br>        <span class="hljs-comment">// token有效期为2小时</span><br>        Calendar calendar = Calendar.getInstance();<br>        calendar.setTime(<span class="hljs-keyword">new</span> Date());<br>        calendar.add(Calendar.SECOND, <span class="hljs-number">7200</span>);<br>        Date expireTime = calendar.getTime();<br><br><br>        <span class="hljs-comment">// 4. 保存token</span><br>        ValueOperations&lt;String, TokenInfo&gt; operations = redisTemplate.opsForValue();<br>        TokenInfo tokenInfo = <span class="hljs-keyword">new</span> TokenInfo();<br>        tokenInfo.setTokenType(tokenType);<br>        tokenInfo.setAppInfo(appInfo);<br><br><br>        <span class="hljs-keyword">if</span> (tokenType == <span class="hljs-number">1</span>) &#123;<br>            tokenInfo.setUserInfo(userInfo);<br>        &#125;<br><br><br>        operations.set(token, tokenInfo, <span class="hljs-number">7200</span>, TimeUnit.SECONDS);<br><br><br>        AccessToken accessToken = <span class="hljs-keyword">new</span> AccessToken(token, expireTime);<br><br><br>        <span class="hljs-keyword">return</span> accessToken;<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">long</span> timestamp = System.currentTimeMillis();<br>        System.out.println(timestamp);<br>        String signString = timestamp + <span class="hljs-string">&quot;1&quot;</span> + <span class="hljs-string">&quot;12345678954556&quot;</span>;<br>        String sign = MD5Util.encode(signString);<br>        System.out.println(sign);<br><br><br>        System.out.println(<span class="hljs-string">&quot;-------------------&quot;</span>);<br>        signString = <span class="hljs-string">&quot;password=123456&amp;username=1&amp;12345678954556&quot;</span> + <span class="hljs-string">&quot;ff03e64b-427b-45a7-b78b-47d9e8597d3b1529815393153sdfsdfsfs&quot;</span> + timestamp + <span class="hljs-string">&quot;A1scr6&quot;</span>;<br>        sign = MD5Util.encode(signString);<br>        System.out.println(sign);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>4. WebMvcConfiguration</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebMvcConfiguration</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebMvcConfigurationSupport</span> </span>&#123;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] excludePathPatterns  = &#123;<span class="hljs-string">&quot;/api/token/api_token&quot;</span>&#125;;<br><br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TokenInterceptor tokenInterceptor;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.addInterceptors(registry);<br>        registry.addInterceptor(tokenInterceptor)<br>                .addPathPatterns(<span class="hljs-string">&quot;/api/**&quot;</span>)<br>                .excludePathPatterns(excludePathPatterns);<br>    &#125;<br>&#125;<br><span class="hljs-number">5.</span> TokenInterceptor<br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TokenInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HandlerInterceptorAdapter</span> </span>&#123;<br><br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> handler 访问的目标方法</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        String token = request.getHeader(<span class="hljs-string">&quot;token&quot;</span>);<br>        String timestamp = request.getHeader(<span class="hljs-string">&quot;timestamp&quot;</span>);<br>        <span class="hljs-comment">// 随机字符串</span><br>        String nonce = request.getHeader(<span class="hljs-string">&quot;nonce&quot;</span>);<br>        String sign = request.getHeader(<span class="hljs-string">&quot;sign&quot;</span>);<br>        Assert.isTrue(!StringUtils.isEmpty(token) &amp;&amp; !StringUtils.isEmpty(timestamp) &amp;&amp; !StringUtils.isEmpty(sign), <span class="hljs-string">&quot;参数错误&quot;</span>);<br><br><br>        <span class="hljs-comment">// 获取超时时间</span><br>        NotRepeatSubmit notRepeatSubmit = ApiUtil.getNotRepeatSubmit(handler);<br>        <span class="hljs-keyword">long</span> expireTime = notRepeatSubmit == <span class="hljs-keyword">null</span> ? <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span> : notRepeatSubmit.value();<br><br><br>        <span class="hljs-comment">// 2. 请求时间间隔</span><br>        <span class="hljs-keyword">long</span> reqeustInterval = System.currentTimeMillis() - Long.valueOf(timestamp);<br>        Assert.isTrue(reqeustInterval &lt; expireTime, <span class="hljs-string">&quot;请求超时，请重新请求&quot;</span>);<br><br><br>        <span class="hljs-comment">// 3. 校验Token是否存在</span><br>        ValueOperations&lt;String, TokenInfo&gt; tokenRedis = redisTemplate.opsForValue();<br>        TokenInfo tokenInfo = tokenRedis.get(token);<br>        Assert.notNull(tokenInfo, <span class="hljs-string">&quot;token错误&quot;</span>);<br><br><br>        <span class="hljs-comment">// 4. 校验签名(将所有的参数加进来，防止别人篡改参数) 所有参数看参数名升续排序拼接成url</span><br>        <span class="hljs-comment">// 请求参数 + token + timestamp + nonce</span><br>        String signString = ApiUtil.concatSignString(request) + tokenInfo.getAppInfo().getKey() + token + timestamp + nonce;<br>        String signature = MD5Util.encode(signString);<br>        <span class="hljs-keyword">boolean</span> flag = signature.equals(sign);<br>        Assert.isTrue(flag, <span class="hljs-string">&quot;签名错误&quot;</span>);<br><br><br>        <span class="hljs-comment">// 5. 拒绝重复调用(第一次访问时存储，过期时间和请求超时时间保持一致), 只有标注不允许重复提交注解的才会校验</span><br>        <span class="hljs-keyword">if</span> (notRepeatSubmit != <span class="hljs-keyword">null</span>) &#123;<br>            ValueOperations&lt;String, Integer&gt; signRedis = redisTemplate.opsForValue();<br>            <span class="hljs-keyword">boolean</span> exists = redisTemplate.hasKey(sign);<br>            Assert.isTrue(!exists, <span class="hljs-string">&quot;请勿重复提交&quot;</span>);<br>            signRedis.set(sign, <span class="hljs-number">0</span>, expireTime, TimeUnit.MILLISECONDS);<br>        &#125;<br><br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.preHandle(request, response, handler);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>6. MD5Util —-MD5工具类，加密生成数字签名</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MD5Util</span> </span>&#123;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String hexDigits[] = &#123; <span class="hljs-string">&quot;0&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>, <span class="hljs-string">&quot;3&quot;</span>, <span class="hljs-string">&quot;4&quot;</span>, <span class="hljs-string">&quot;5&quot;</span>,<br>            <span class="hljs-string">&quot;6&quot;</span>, <span class="hljs-string">&quot;7&quot;</span>, <span class="hljs-string">&quot;8&quot;</span>, <span class="hljs-string">&quot;9&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-string">&quot;d&quot;</span>, <span class="hljs-string">&quot;e&quot;</span>, <span class="hljs-string">&quot;f&quot;</span> &#125;;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">byteArrayToHexString</span><span class="hljs-params">(<span class="hljs-keyword">byte</span> b[])</span> </span>&#123;<br>        StringBuffer resultSb = <span class="hljs-keyword">new</span> StringBuffer();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; b.length; i++)<br>            resultSb.append(byteToHexString(b[i]));<br><br><br>        <span class="hljs-keyword">return</span> resultSb.toString();<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">byteToHexString</span><span class="hljs-params">(<span class="hljs-keyword">byte</span> b)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> n = b;<br>        <span class="hljs-keyword">if</span> (n &lt; <span class="hljs-number">0</span>)<br>            n += <span class="hljs-number">256</span>;<br>        <span class="hljs-keyword">int</span> d1 = n / <span class="hljs-number">16</span>;<br>        <span class="hljs-keyword">int</span> d2 = n % <span class="hljs-number">16</span>;<br>        <span class="hljs-keyword">return</span> hexDigits[d1] + hexDigits[d2];<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">encode</span><span class="hljs-params">(String origin)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> encode(origin, <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">encode</span><span class="hljs-params">(String origin, String charsetname)</span> </span>&#123;<br>        String resultString = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            resultString = <span class="hljs-keyword">new</span> String(origin);<br>            MessageDigest md = MessageDigest.getInstance(<span class="hljs-string">&quot;MD5&quot;</span>);<br>            <span class="hljs-keyword">if</span> (charsetname == <span class="hljs-keyword">null</span> || <span class="hljs-string">&quot;&quot;</span>.equals(charsetname))<br>                resultString = byteArrayToHexString(md.digest(resultString<br>                        .getBytes()));<br>            <span class="hljs-keyword">else</span><br>                resultString = byteArrayToHexString(md.digest(resultString<br>                        .getBytes(charsetname)));<br>        &#125; <span class="hljs-keyword">catch</span> (Exception exception) &#123;<br>        &#125;<br>        <span class="hljs-keyword">return</span> resultString;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>7. @NotRepeatSubmit —–自定义注解，防止重复提交。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 禁止重复提交</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Target(ElementType.METHOD)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> NotRepeatSubmit &#123;<br>    <span class="hljs-comment">/** 过期时间，单位毫秒 **/</span><br>    <span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">value</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> 5000</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>8. AccessToken</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AccessToken</span> </span>&#123;<br>    <span class="hljs-comment">/** token */</span><br>    <span class="hljs-keyword">private</span> String token;<br><br><br>    <span class="hljs-comment">/** 失效时间 */</span><br>    <span class="hljs-keyword">private</span> Date expireTime;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>9. AppInfo</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppInfo</span> </span>&#123;<br>    <span class="hljs-comment">/** App id */</span><br>    <span class="hljs-keyword">private</span> String appId;<br>    <span class="hljs-comment">/** API 秘钥 */</span><br>    <span class="hljs-keyword">private</span> String key;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>10. TokenInfo</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TokenInfo</span> </span>&#123;<br>    <span class="hljs-comment">/** token类型: api:0 、user:1 */</span><br>    <span class="hljs-keyword">private</span> Integer tokenType;<br><br><br>    <span class="hljs-comment">/** App 信息 */</span><br>    <span class="hljs-keyword">private</span> AppInfo appInfo;<br><br><br>    <span class="hljs-comment">/** 用户其他数据 */</span><br>    <span class="hljs-keyword">private</span> UserInfo userInfo;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>11. UserInfo</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserInfo</span> </span>&#123;<br>    <span class="hljs-comment">/** 用户名 */</span><br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-comment">/** 手机号 */</span><br>    <span class="hljs-keyword">private</span> String mobile;<br>    <span class="hljs-comment">/** 邮箱 */</span><br>    <span class="hljs-keyword">private</span> String email;<br>    <span class="hljs-comment">/** 密码 */</span><br>    <span class="hljs-keyword">private</span> String password;<br>    <span class="hljs-comment">/** 盐 */</span><br>    <span class="hljs-keyword">private</span> String salt;<br><br><br>    <span class="hljs-keyword">private</span> AccessToken accessToken;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">UserInfo</span><span class="hljs-params">(String username, String password, String salt)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.username = username;<br>        <span class="hljs-keyword">this</span>.password = password;<br>        <span class="hljs-keyword">this</span>.salt = salt;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>12. ApiCodeEnum</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 错误码code可以使用纯数字,使用不同区间标识一类错误，也可以使用纯字符，也可以使用前缀+编号</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 错误码：ERR + 编号</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 可以使用日志级别的前缀作为错误类型区分 Info(I) Error(E) Warning(W)</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 或者以业务模块 + 错误号</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * TODO 错误码设计</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Alipay 用了两个code，两个msg(https://docs.open.alipay.com/api_1/alipay.trade.pay)</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> ApiCodeEnum &#123;<br>    SUCCESS(<span class="hljs-string">&quot;10000&quot;</span>, <span class="hljs-string">&quot;success&quot;</span>),<br>    UNKNOW_ERROR(<span class="hljs-string">&quot;ERR0001&quot;</span>,<span class="hljs-string">&quot;未知错误&quot;</span>),<br>    PARAMETER_ERROR(<span class="hljs-string">&quot;ERR0002&quot;</span>,<span class="hljs-string">&quot;参数错误&quot;</span>),<br>    TOKEN_EXPIRE(<span class="hljs-string">&quot;ERR0003&quot;</span>,<span class="hljs-string">&quot;认证过期&quot;</span>),<br>    REQUEST_TIMEOUT(<span class="hljs-string">&quot;ERR0004&quot;</span>,<span class="hljs-string">&quot;请求超时&quot;</span>),<br>    SIGN_ERROR(<span class="hljs-string">&quot;ERR0005&quot;</span>,<span class="hljs-string">&quot;签名错误&quot;</span>),<br>    REPEAT_SUBMIT(<span class="hljs-string">&quot;ERR0006&quot;</span>,<span class="hljs-string">&quot;请不要频繁操作&quot;</span>),<br>    ;<br><br><br>    <span class="hljs-comment">/** 代码 */</span><br>    <span class="hljs-keyword">private</span> String code;<br><br><br>    <span class="hljs-comment">/** 结果 */</span><br>    <span class="hljs-keyword">private</span> String msg;<br><br><br>    ApiCodeEnum(String code, String msg) &#123;<br>        <span class="hljs-keyword">this</span>.code = code;<br>        <span class="hljs-keyword">this</span>.msg = msg;<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getCode</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> code;<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMsg</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> msg;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>13. ApiResult</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApiResult</span> </span>&#123;<br><br><br>    <span class="hljs-comment">/** 代码 */</span><br>    <span class="hljs-keyword">private</span> String code;<br><br><br>    <span class="hljs-comment">/** 结果 */</span><br>    <span class="hljs-keyword">private</span> String msg;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>14. ApiUtil ——-这个参考支付宝加密的算法写的.我直接Copy过来了。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApiUtil</span> </span>&#123;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 按参数名升续拼接参数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">concatSignString</span><span class="hljs-params">(HttpServletRequest request)</span> </span>&#123;<br>        Map&lt;String, String&gt; paramterMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        request.getParameterMap().forEach((key, value) -&gt; paramterMap.put(key, value[<span class="hljs-number">0</span>]));<br>        <span class="hljs-comment">// 按照key升续排序，然后拼接参数</span><br>        Set&lt;String&gt; keySet = paramterMap.keySet();<br>        String[] keyArray = keySet.toArray(<span class="hljs-keyword">new</span> String[keySet.size()]);<br>        Arrays.sort(keyArray);<br>        StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder();<br>        <span class="hljs-keyword">for</span> (String k : keyArray) &#123;<br>            <span class="hljs-comment">// 或略掉的字段</span><br>            <span class="hljs-keyword">if</span> (k.equals(<span class="hljs-string">&quot;sign&quot;</span>)) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (paramterMap.get(k).trim().length() &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// 参数值为空，则不参与签名</span><br>                sb.append(k).append(<span class="hljs-string">&quot;=&quot;</span>).append(paramterMap.get(k).trim()).append(<span class="hljs-string">&quot;&amp;&quot;</span>);<br>            &#125;<br>        &#125;<br><br><br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">concatSignString</span><span class="hljs-params">(Map&lt;String, String&gt; map)</span> </span>&#123;<br>        Map&lt;String, String&gt; paramterMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        map.forEach((key, value) -&gt; paramterMap.put(key, value));<br>        <span class="hljs-comment">// 按照key升续排序，然后拼接参数</span><br>        Set&lt;String&gt; keySet = paramterMap.keySet();<br>        String[] keyArray = keySet.toArray(<span class="hljs-keyword">new</span> String[keySet.size()]);<br>        Arrays.sort(keyArray);<br>        StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder();<br>        <span class="hljs-keyword">for</span> (String k : keyArray) &#123;<br>            <span class="hljs-keyword">if</span> (paramterMap.get(k).trim().length() &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// 参数值为空，则不参与签名</span><br>                sb.append(k).append(<span class="hljs-string">&quot;=&quot;</span>).append(paramterMap.get(k).trim()).append(<span class="hljs-string">&quot;&amp;&quot;</span>);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取方法上的<span class="hljs-doctag">@NotRepeatSubmit</span>注解</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> handler</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotRepeatSubmit <span class="hljs-title">getNotRepeatSubmit</span><span class="hljs-params">(Object handler)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (handler <span class="hljs-keyword">instanceof</span> HandlerMethod) &#123;<br>            HandlerMethod handlerMethod = (HandlerMethod) handler;<br>            Method method = handlerMethod.getMethod();<br>            NotRepeatSubmit annotation = method.getAnnotation(NotRepeatSubmit.class);<br><br><br>            <span class="hljs-keyword">return</span> annotation;<br>        &#125;<br><br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>15. ApiResponse</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApiResponse</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;<br>    <span class="hljs-comment">/** 结果 */</span><br>    <span class="hljs-keyword">private</span> ApiResult result;<br><br><br>    <span class="hljs-comment">/** 数据 */</span><br>    <span class="hljs-keyword">private</span> T data;<br><br><br>    <span class="hljs-comment">/** 签名 */</span><br>    <span class="hljs-keyword">private</span> String sign;<br><br><br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-function">ApiResponse <span class="hljs-title">success</span><span class="hljs-params">(T data)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> response(ApiCodeEnum.SUCCESS.getCode(), ApiCodeEnum.SUCCESS.getMsg(), data);<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ApiResponse <span class="hljs-title">error</span><span class="hljs-params">(String code, String msg)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> response(code, msg, <span class="hljs-keyword">null</span>);<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-function">ApiResponse <span class="hljs-title">response</span><span class="hljs-params">(String code, String msg, T data)</span> </span>&#123;<br>        ApiResult result = <span class="hljs-keyword">new</span> ApiResult(code, msg);<br>        ApiResponse response = <span class="hljs-keyword">new</span> ApiResponse();<br>        response.setResult(result);<br>        response.setData(data);<br><br><br>        String sign = signData(data);<br>        response.setSign(sign);<br><br><br>        <span class="hljs-keyword">return</span> response;<br>    &#125;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-function">String <span class="hljs-title">signData</span><span class="hljs-params">(T data)</span> </span>&#123;<br>        <span class="hljs-comment">// TODO 查询key</span><br>        String key = <span class="hljs-string">&quot;12345678954556&quot;</span>;<br>        Map&lt;String, String&gt; responseMap = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            responseMap = getFields(data);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>        String urlComponent = ApiUtil.concatSignString(responseMap);<br>        String signature = urlComponent + <span class="hljs-string">&quot;key=&quot;</span> + key;<br>        String sign = MD5Util.encode(signature);<br><br><br>        <span class="hljs-keyword">return</span> sign;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> data 反射的对象,获取对象的字段名和值</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalAccessException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;String, String&gt; <span class="hljs-title">getFields</span><span class="hljs-params">(Object data)</span> <span class="hljs-keyword">throws</span> IllegalAccessException, IllegalArgumentException </span>&#123;<br>        <span class="hljs-keyword">if</span> (data == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        Map&lt;String, String&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        Field[] fields = data.getClass().getDeclaredFields();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; fields.length; i++) &#123;<br>            Field field = fields[i];<br>            field.setAccessible(<span class="hljs-keyword">true</span>);<br><br><br>            String name = field.getName();<br>            Object value = field.get(data);<br>            <span class="hljs-keyword">if</span> (field.get(data) != <span class="hljs-keyword">null</span>) &#123;<br>                map.put(name, value.toString());<br>            &#125;<br>        &#125;<br><br><br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="七、ThreadLocal"><a href="#七、ThreadLocal" class="headerlink" title="七、ThreadLocal"></a><strong>七、ThreadLocal</strong></h2><p>ThreadLocal是线程内的全局上下文。就是在单个线程中，方法之间共享的内存，每个方法都可以从该上下文中获取值和修改值。</p>
<p><strong>实际案例：</strong></p>
<p>在调用api时都会传一个token参数，通常会写一个拦截器来校验token是否合法，我们可以通过token找到对应的用户信息(User)，如果token合法，然后将用户信息存储到ThreadLocal中，这样无论是在controller、service、dao的哪一层都能访问到该用户的信息。作用类似于Web中的request作用域。</p>
<p>传统方式我们要在方法中访问某个变量，可以通过传参的形式往方法中传参，如果多个方法都要使用那么每个方法都要传参；如果使用ThreadLocal所有方法就不需要传该参数了，每个方法都可以通过ThreadLocal来访问该值。</p>
<ul>
<li>ThreadLocalUtil.set(“key”, value); 保存值</li>
<li>T value = ThreadLocalUtil.get(“key”); 获取值</li>
</ul>
<p>ThreadLocalUtil</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadLocalUtil</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Map&lt;String, Object&gt;&gt; threadLocal = <span class="hljs-keyword">new</span> ThreadLocal() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> Map&lt;String, Object&gt; <span class="hljs-title">initialValue</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> HashMap&lt;&gt;(<span class="hljs-number">4</span>);<br>        &#125;<br>    &#125;;<br><br><br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;String, Object&gt; <span class="hljs-title">getThreadLocal</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> threadLocal.get();<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">get</span><span class="hljs-params">(String key)</span> </span>&#123;<br>        Map map = (Map)threadLocal.get();<br>        <span class="hljs-keyword">return</span> (T)map.get(key);<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">get</span><span class="hljs-params">(String key,T defaultValue)</span> </span>&#123;<br>        Map map = (Map)threadLocal.get();<br>        <span class="hljs-keyword">return</span> (T)map.get(key) == <span class="hljs-keyword">null</span> ? defaultValue : (T)map.get(key);<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">set</span><span class="hljs-params">(String key, Object value)</span> </span>&#123;<br>        Map map = (Map)threadLocal.get();<br>        map.put(key, value);<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">set</span><span class="hljs-params">(Map&lt;String, Object&gt; keyValueMap)</span> </span>&#123;<br>        Map map = (Map)threadLocal.get();<br>        map.putAll(keyValueMap);<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">remove</span><span class="hljs-params">()</span> </span>&#123;<br>        threadLocal.remove();<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-function">Map&lt;String,T&gt; <span class="hljs-title">fetchVarsByPrefix</span><span class="hljs-params">(String prefix)</span> </span>&#123;<br>        Map&lt;String,T&gt; vars = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        <span class="hljs-keyword">if</span>( prefix == <span class="hljs-keyword">null</span> )&#123;<br>            <span class="hljs-keyword">return</span> vars;<br>        &#125;<br>        Map map = (Map)threadLocal.get();<br>        Set&lt;Map.Entry&gt; set = map.entrySet();<br><br><br>        <span class="hljs-keyword">for</span>( Map.Entry entry : set)&#123;<br>            Object key = entry.getKey();<br>            <span class="hljs-keyword">if</span>( key <span class="hljs-keyword">instanceof</span> String )&#123;<br>                <span class="hljs-keyword">if</span>( ((String) key).startsWith(prefix) )&#123;<br>                    vars.put((String)key,(T)entry.getValue());<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> vars;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">remove</span><span class="hljs-params">(String key)</span> </span>&#123;<br>        Map map = (Map)threadLocal.get();<br>        <span class="hljs-keyword">return</span> (T)map.remove(key);<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clear</span><span class="hljs-params">(String prefix)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>( prefix == <span class="hljs-keyword">null</span> )&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        Map map = (Map)threadLocal.get();<br>        Set&lt;Map.Entry&gt; set = map.entrySet();<br>        List&lt;String&gt; removeKeys = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br><br><br>        <span class="hljs-keyword">for</span>( Map.Entry entry : set )&#123;<br>            Object key = entry.getKey();<br>            <span class="hljs-keyword">if</span>( key <span class="hljs-keyword">instanceof</span> String )&#123;<br>                <span class="hljs-keyword">if</span>( ((String) key).startsWith(prefix) )&#123;<br>                    removeKeys.add((String)key);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span>( String key : removeKeys )&#123;<br>            map.remove(key);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
    </section>
    <section class="extra">
      
        <ul class="copyright">
  
  <li><strong>本文作者：</strong>Libowen</li>
  <li><strong>本文链接：</strong><a href="libowen.info/2020/08/28/archives/api%E8%AE%BE%E8%AE%A1/index.html">libowen.info/2020/08/28/archives/api%E8%AE%BE%E8%AE%A1/index.html</a></li>
  <li><strong>版权声明：</strong>本博客所有文章均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"
      rel="external nofollow" target="_blank"> BY-NC-SA </a>许可协议，转载请注明出处！</li>
  
</ul>
      
      
        <section class="donate">
  <div class="qrcode">
    <img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/leebw529/pic/img/Yssy17eo0u.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" >
  </div>
  <div class="icon">
    <a href="javascript:;" id="alipay"><i class="iconfont iconalipay"></i></a>
    <a href="javascript:;" id="wechat"><i class="iconfont iconwechat-fill"></i></a>
  </div>
</section>
      
      
      
<nav class="nav">
  
    <a href="/2020/08/29/%E5%86%92%E6%B3%A1%E6%8E%92%E5%BA%8F/"><i class="iconfont iconleft"></i>冒泡排序</a>
  
  
    <a href="/2020/08/12/archives/pandocuse/">pandoc的基本使用方法<i class="iconfont iconright"></i></a>
  
</nav>

    </section>
    
      <section class="comments">
        
          <div class="btn" id="comments-btn">查看评论</div>
        
        
      </section>
    
  </section>
</article>
  </div>
</main>
  <footer class="footer">
  <div class="footer-social">
    
    
    
    
    
    <a href="tencent://message/?Menu=yes&uin=1609828358 " target="_blank" onMouseOver="this.style.color= '#12B7F5'"
      onMouseOut="this.style.color='#33333D'">
      <i class="iconfont footer-social-item  iconQQ "></i>
    </a>
    
    
    
    
    
    <a href="javascript:; " target="_blank" onMouseOver="this.style.color= '#09BB07'"
      onMouseOut="this.style.color='#33333D'">
      <i class="iconfont footer-social-item  iconwechat-fill "></i>
    </a>
    
    
    
    
    
    <a href="jsvascript:; " target="_blank" onMouseOver="this.style.color= '#DA2E76'"
      onMouseOut="this.style.color='#33333D'">
      <i class="iconfont footer-social-item  iconinstagram "></i>
    </a>
    
    
    
    
    
    <a href="https://github.com/BroncLee " target="_blank" onMouseOver="this.style.color= '#24292E'"
      onMouseOut="this.style.color='#33333D'">
      <i class="iconfont footer-social-item  icongithub-fill "></i>
    </a>
    
    
    
    
    
    <a href="mailto:leebw529@163.com " target="_blank" onMouseOver="this.style.color='#FFBE5B'"
      onMouseOut="this.style.color='#33333D'">
      <i class="iconfont footer-social-item  iconmail"></i>
    </a>
    
  </div>
  <div class="footer-copyright"><p>还好 还好 还好遇见过你</p></div>
</footer>
  
      <div class="fab fab-plus">
    <i class="iconfont iconplus"></i>
  </div>
  
  <div class="fab fab-daovoice">
    <i class="iconfont iconcomment"></i>
  </div>
  
  <div class="fab fab-up">
    <i class="iconfont iconcaret-up"></i>
  </div>
  <div class="fab fab-menu">
    <i class="iconfont iconmenu"></i>
  </div>
  
</body>


<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>






<script src="https://cdn.bootcdn.net/ajax/libs/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>






<script src="https://cdn.bootcdn.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js"></script>






<script src="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.js"></script>






<script src="/js/utils.js"></script>
<script src="/js/modules.js"></script>
<script src="/js/zui.js"></script>
<script src="/js/script.js"></script>





<script>
  (function (i, s, o, g, r, a, m) {
    i["DaoVoiceObject"] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o), m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    a.charset = "utf-8";
    m.parentNode.insertBefore(a, m)
  })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
    "//widget.daovoice.io/widget/0f81ff2f.js", "daovoice")
  daovoice('init', {
    app_id: "abcdefg"
  }, {
    launcher: {
      disableLauncherIcon: true,
    },
  });
  daovoice('update');
</script>



<script>
  (function () {
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
      bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    } else {
      bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
  })();
</script>


<script>
  var _hmt = _hmt || [];
  (function () {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?4c204d8bc027a0455b5fc642ac334ca8";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>










</html>